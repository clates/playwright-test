name: Post Worldbuilder Regression
on:
  issue_comment:
    types: [created]

jobs:
  pr_commented:
    # This job only runs for pull request comments
    name: PR comment
    if: ${{ github.event.issue.pull_request }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      # Extract the world from the comment and run the test
      # Integration Test World URL (client-app-ci-pr-8693-24-stage-world): ðŸ‘‰ https://client-app-ci-pr-8693-24-stage-world.crunchbase.io/
      - id: extract
        run: |
          echo "Extracting world URL from comment"
          echo $EVENT
          BASE_URL="${EVENT#*ðŸ‘‰ }"
          echo $BASE_URL
          if [ -z "$BASE_URL" ]
          then
                echo "No world URL found in comment"
                exit 1
          fi
          echo "Comment contained trigger $BASE_URL"
          if [[ $BASE_URL =~ ^https://.*\.crunchbase\.com/$ ]]
          then
                echo "World URL is valid (.com)"
                echo "::set-output name=world_url::$BASE_URL"  
                exit 0
          fi
          if [[ $BASE_URL =~ ^https://.*\.crunchbase\.io/$ ]]
          then
                echo "World URL is valid"
                echo "::set-output name=world_url::$BASE_URL"  
                exit 0
          else
                echo "World URL is invalid"
                exit 1
          fi
        env:
          NUMBER: ${{ github.event.issue.number }}
          EVENT: ${{ github.event.comment.body }}
      - id: runPlaywright
        run: |
          echo "Running playwright test"
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps
      - name: Run Playwright tests
        run: |          
          CI=true BASE_URL="https://www.uuidgenerator.com/" npx playwright test --update-snapshots
          CI=true BASE_URL=${{ steps.extract.outputs.world_url }} npx playwright test
    outputs:
      world_url: ${{ steps.extract.outputs.world_url }}

    #   - run: |
    #         echo "Running playwright test"
    #         npm install
    #         npm run test:playwright
#   blah:
#     name: Create pull request
#     uses: actions/github-script@v6.4.1
#     with:
#         # github-token: ${{ secrets.CI_GITHUB_TOKEN }}
#         script: |
#             const script = require('./.github/scripts/triggerPlaywright.js');
#             await script(github, context, core);
